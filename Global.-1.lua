TABLE_HEIGHT = 1.41

-- ! OBJECTS PLACEMENT
PLAYERS = {
    white = {
        origin = {},
        objects = {
            non_buyable_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            brown_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            grey_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            commerce_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            blue_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            war_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            naval_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            compass_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            tablet_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            gear_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            green_island_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            purple_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            black_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },
        }
    },

    purple = {
        origin = {},
        objects = {
            non_buyable_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            brown_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            grey_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            commerce_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            blue_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            war_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            naval_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            compass_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            tablet_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            gear_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            green_island_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            purple_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            black_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },
        }
    },

    red = {
        origin = {},
        objects = {
            non_buyable_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            brown_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            grey_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            commerce_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            blue_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            war_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            naval_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            compass_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            tablet_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            gear_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            green_island_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            purple_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            black_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },
        }
    },

    yellow = {
        origin = {},
        objects = {
            non_buyable_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            brown_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            grey_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            commerce_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            blue_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            war_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            naval_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            compass_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            tablet_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            gear_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            green_island_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            purple_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            black_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },
        }
    },

    green = {
        origin = {},
        objects = {
            non_buyable_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            brown_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            grey_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            commerce_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            blue_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            war_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            naval_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            compass_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            tablet_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            gear_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            green_island_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            purple_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            black_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },
        }
    },

    orange = {
        origin = {},
        objects = {
            non_buyable_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            brown_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            grey_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            commerce_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            blue_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            war_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            naval_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            compass_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            tablet_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            gear_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            green_island_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            purple_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            black_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },
        }
    },

    blue = {
        origin = {},
        objects = {
            non_buyable_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            brown_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            grey_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            commerce_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            blue_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            war_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            naval_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            compass_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            tablet_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            gear_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            green_island_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            purple_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            black_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            }
        }
    }
}

OBJECTS_OFFSETS = {
    ['stacks'] = {
        ['non_buyable_res_stack'] = -16.2,
        ['brown_res_stack'] = -13.50,
        ['grey_stack'] = -10.80,
        ['commerce_stack'] = -8.10,
        ['blue_stack'] = -5.40,
        ['war_conflict_stack'] = -2.70,
        ['naval_conflict_stack'] = 0,
        ['compass_stack'] = 2.70,
        ['tablet_stack'] = 5.40,
        ['gear_stack'] = 8.10,
        ['green_island_stack'] = 10.80,
        ['purple_stack'] = 13.50,
        ['black_stack'] = 16.2,

        ['z'] = 41
    },

    ['wonder'] = 14,
    
    ['coins'] = {
        x = 5,
        z = 17.5,
        padding = -0.80
    }
}

-- ! CARDS AND TOKENS GUID

-- base game
BASE_DECK_GUID = {
    ['age1'] = {'501ae8', '9b51a7', '6123d4', 'bf52e6', 'a5a6ee'},
    ['age2'] = {'8e40b9', '1a8f31', 'e96ff5', '912d26', '453cee'},
    ['age3'] = {'88f04b', '92c03a', 'b0035e', 'c2a4ea', '864847'}
}

GUILD_DECK_GUID = 'a5b1c7'

WONDERS_BAGS = {
    ['base'] = '56d45b',
    ['leaders'] = '053343',
    ['cities'] = 'a49969',
    ['armada'] = 'e1435d',
    ['edifice'] = 'd9d9c0'
}

COINS_BAGS = {
    '3f95a5',
    '3cad45',
    '9e60c9'
}

-- ! ONLOAD()
function onLoad(saved_data)
    calulcateOrigins()

    populateStatusPanel()
end

-- ! FUNCTIONS 
-- if you are looking for something it's probably in the onLoad() function 
function onPlayerChangeColor(player_color)
    populateStatusPanel()
end

-- one important feature of this mod is the auto placement of cards
-- every single column in a player's board is made for specific kind of cards (not colors)
-- so to make things easier we calculate every origin(x, y, z) for each stack
function calulcateOrigins()
    -- instaed of editing every value of PLAYERS we'll just use a temp table
    local new_stack = Global.getTable('PLAYERS')

    for _, color in pairs(getSeatedPlayers()) do

        -- for every player we calculate these origins based on its hand transform (position, rotation etc. etc.)
        local origin = Player[string.lower(color)].getHandTransform(1)

        -- a table of offsets for each kind of cards
        local stack_offsets = Global.getTable('OBJECTS_OFFSETS')['stacks']

        -- for every kind of stack we then calculate the origin using our offsets
        for stack_name, _ in pairs(new_stack[string.lower(color)]['objects']) do

            -- the origin we are going to calculate
            local stack_origin = Vector(0, 0, 0)
            stack_origin[1] = origin.position[1] + origin.forward[1] * stack_offsets['z'] + origin.right[1] * stack_offsets[stack_name]
            stack_origin[2] = TABLE_HEIGHT
            stack_origin[3] = origin.position[3] + origin.forward[3] * stack_offsets['z'] + origin.right[3] * stack_offsets[stack_name]

            -- in the end we update the origin in our temp table
            new_stack[string.lower(color)]['objects'][stack_name]['origin'] = stack_origin
        end

    end

    -- lastly we commit the changes to the original table
    Global.setTable('PLAYERS', new_stack)

end

function populateStatusPanel()

    -- ! docstring
    -- the goal for this function is to populate the status UI everytime a player joins or changes color
    -- inside our Global.xml we already have a <TableLayout> inside a <Panel> ready to be populated

    -- for every n players we will "build" n rows to collect inside a table 
    -- the xml schema for every row will be as follow
    -- ? <Row>
    -- ?     <Cell>
    -- ?          <Panel class = 'statusBox'>
    -- ?          </Panel>
    -- ?     </Cell>
    -- ?     <Cell>
    -- ?          <Text class = 'playerName'> player.steam_name</Text>
    -- ?     </Cell>
    -- ? </Row>

    -- once we've built all the rows we'll "overwrite" the current children of <TableLayout>
    -- and not append the new children to the old ones
    -- otherwise the status panel will append every new row without removing the old ones

    -- ! real function
    -- all the tags inside Global.xml
    local xml_table = self.UI.getXmlTable()

    -- this we'll be our "collection" of all the row tags
    -- one row (=table) for each player in the match
    local new_children = {}

    -- except for the first table, it will be the title of our panel
    new_children[1] = xml_table[2]      -- the second child of Global.xml that is <Panel>    
                        .children[1]    -- the first child of <Panel> that is <TableLayout>
                        .children[1]    -- the first child of <TableLayout> that is the title row

    -- now for each player we will generate a row tag
    -- containing his status box and his steam name 
    for _, player in pairs(getValidPlayers()) do

        -- start reading this from the last table, the row_player  

        -- the player name in question
        local text_player_name = {
            tag            = 'Text',
            attributes     = {class = 'textPlayerName'},
            value          = player.color, -- TODO change to steam_name 
            children       = {}
        }

        -- and this is the second and last child of the <Row>
        -- this <Cell> contains that player's name, it will be displayed next to his status
        local cell_player_name = {
            tag            = 'Cell',
            attributes     = {},
            children       = {text_player_name}
        }

        -- the status box in question
        local panel_player_status = {
            tag            = 'Panel',
            attributes     = {class = 'panelPlayerStatus'},
            children       = {}
        }

        -- this is the first child tag, the <Cell> containg the status box
        -- this box will display whenever a player is ready or not
        local cell_player_status = {
            tag            = 'Cell',
            attributes     = {},
            children       = {panel_player_status}
        }

        -- this the parent tag <Row> that contains every other table you see above this 
        local row_player = {
            tag            = 'Row',
            attributes     = {},
            children       = {cell_player_status, cell_player_name}
        }

        -- after building this tag we'll append to our collection
        new_children[#new_children + 1] = row_player
    end

    -- at the end of the loop we'll overwrite the table's children
    -- same strucutre as before 
    xml_table[2].children[1].children = new_children

    -- lastly we set and update the panel using the LuaCoroutine
    self.UI.setXmlTable(xml_table)
    updateStatusPanelUI(#getValidPlayers())

    -- TODO remove comment 
    -- local button_ready = {
    --     tag = 'Button',
    --     attributes = {class = 'buttonReady'},
    --     value = 'Ready',
    --     children = {}
    -- }

    -- local row_ready = {
    --     tag = 'Row',
    --     attributes = {preferredHeight = '64'},
    --     children = {button_ready}
    -- }

end

function getValidPlayers()
    -- the tabletop api only gives u the Player.getPlayers() function wich will return a table of Player instances
    -- but we only want the players having a "valid colors" 
    -- so not players in the grey nor black seat
    local valid_colors = {'White', 'Purple', 'Red', 'Yellow', 'Green', 'Orange', 'Blue'}
    local valid_players = {}

    -- we compare every player's color with every valid colors and just append the ones that matches
    for _, player in pairs(Player.getPlayers()) do
        for _, color in pairs(valid_colors) do
            if player.color == color then
                table.insert(valid_players, player)
            end
        end
    end

    -- this is a Player instances table
    -- its pretty useful because we can get the steam name, the steam id, the color and many other things
    return valid_players
end

-- since the startLuaCoroutine() function does not let you use paramaters
-- we use this first function as the "outside" of the coroutine function
-- thanks to it we can use its paramater in the "inside"
function updateStatusPanelUI(n_players)
    function coinside()

        -- pauses the couritine to resolve the UI
        coroutine.yield(0)

        -- to "visually" add a row inside our panel we have to edit its height, using:
        -- 1) each row height
        -- 2) the spacing between each one of them
        -- 3) the height of the panel itself
        -- 4) the padding of the panel
        local row_height = tonumber(UI.getAttribute('rowPlayer', 'preferredHeight'))
        local table_spacing = tonumber(UI.getAttribute('tableStatus', 'cellSpacing'))
        local panel_height = tonumber(UI.getAttribute('panelStatus', 'height'))
        local panel_padding = tonumber(UI.getAttribute('panelStatus', 'padding'))

        -- this is the "minum" size of our panel, meaning the size needed to only contain the title
        local new_panel_height = panel_padding + row_height + table_spacing

        -- and we add to it the new player rows
        new_panel_height = new_panel_height + (row_height + table_spacing) * n_players

        if new_panel_height ~= panel_height then
            -- update panel height
            UI.setAttribute('panelStatus', 'height', new_panel_height)
        end

    return 1
    end

    -- the updateStatusPanelUI() will ignore everything in coinside() and jump right into this 
    -- as you can see this is the real function called by the LuaCoroutine
    startLuaCoroutine(self, 'coinside')

    -- if you are wondering why using a LuaCoroutine to do this it's because (as the docs says)
    -- ! "UI changes do not take effect immediately. Any attempt to query the contents of the XML will return stale results"
    -- the LuaCoroutine generates a new "thread" to "resolve" the UI changes
end

function onChat(message, player)
end