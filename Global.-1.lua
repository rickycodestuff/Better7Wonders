TABLE_HEIGHT = 1.41

-- ! OBJECTS PLACEMENT
PLAYERS = {
    white = {
        origin = {},
        objects = {
            non_buyable_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            brown_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            grey_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            commerce_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            blue_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            war_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            naval_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            compass_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            tablet_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            gear_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            green_island_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            purple_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            black_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },
        }
    },

    purple = {
        origin = {},
        objects = {
            non_buyable_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            brown_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            grey_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            commerce_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            blue_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            war_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            naval_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            compass_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            tablet_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            gear_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            green_island_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            purple_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            black_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },
        }
    },

    red = {
        origin = {},
        objects = {
            non_buyable_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            brown_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            grey_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            commerce_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            blue_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            war_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            naval_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            compass_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            tablet_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            gear_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            green_island_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            purple_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            black_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },
        }
    },

    yellow = {
        origin = {},
        objects = {
            non_buyable_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            brown_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            grey_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            commerce_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            blue_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            war_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            naval_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            compass_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            tablet_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            gear_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            green_island_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            purple_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            black_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },
        }
    },

    green = {
        origin = {},
        objects = {
            non_buyable_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            brown_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            grey_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            commerce_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            blue_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            war_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            naval_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            compass_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            tablet_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            gear_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            green_island_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            purple_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            black_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },
        }
    },

    orange = {
        origin = {},
        objects = {
            non_buyable_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            brown_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            grey_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            commerce_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            blue_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            war_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            naval_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            compass_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            tablet_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            gear_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            green_island_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            purple_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            black_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },
        }
    },

    blue = {
        origin = {},
        objects = {
            non_buyable_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            brown_res_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            grey_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            commerce_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            blue_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            war_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            naval_conflict_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            compass_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            tablet_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            gear_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            green_island_stack = {
                guid_zone = '',
                origin =nil,

                cards = {}
            },

            purple_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            },

            black_stack = {
                guid_zone = '',
                origin = nil,

                cards = {}
            }
        }
    }
}

OBJECTS_OFFSETS = {
    ['stacks'] = {
        ['non_buyable_res_stack'] = -16.2,
        ['brown_res_stack'] = -13.50,
        ['grey_stack'] = -10.80,
        ['commerce_stack'] = -8.10,
        ['blue_stack'] = -5.40,
        ['war_conflict_stack'] = -2.70,
        ['naval_conflict_stack'] = 0,
        ['compass_stack'] = 2.70,
        ['tablet_stack'] = 5.40,
        ['gear_stack'] = 8.10,
        ['green_island_stack'] = 10.80,
        ['purple_stack'] = 13.50,
        ['black_stack'] = 16.2,

        ['z'] = 41
    },

    ['wonder'] = 14,
    
    ['coins'] = {
        x = 5,
        z = 17.5,
        padding = -0.80
    }
}

-- ! CARDS AND TOKENS GUID

-- base game
BASE_DECK_GUID = {
    ['age1'] = {'501ae8', '9b51a7', '6123d4', 'bf52e6', 'a5a6ee'},
    ['age2'] = {'8e40b9', '1a8f31', 'e96ff5', '912d26', '453cee'},
    ['age3'] = {'88f04b', '92c03a', 'b0035e', 'c2a4ea', '864847'}
}

GUILD_DECK_GUID = 'a5b1c7'

WONDERS_BAGS = {
    ['base'] = '56d45b',
    ['leaders'] = '053343',
    ['cities'] = 'a49969',
    ['armada'] = 'e1435d',
    ['edifice'] = 'd9d9c0'
}

COINS_BAGS = {
    '3f95a5',
    '3cad45',
    '9e60c9'
}

-- ! ONLOAD()
function onLoad(saved_data)
    calulcateOrigins()

    populateStatusPanel()
end

-- ! FUNCTIONS 
-- if you are looking for something it's probably in the onLoad() function 
function onPlayerChangeColor(player_color)
    populateStatusPanel()
end

-- one important feature of this mod is the auto placement of cards
-- every single column in a player's board is made for specific kind of cards (not colors)
-- so to make things easier we calculate every origin(x, y, z) for each stack
function calulcateOrigins()
    -- instaed of editing every value of PLAYERS we'll just use a temp table
    local new_stack = Global.getTable('PLAYERS')

    for _, color in pairs(getSeatedPlayers()) do

        -- for every player we calculate these origins based on its hand transform (position, rotation etc. etc.)
        local origin = Player[string.lower(color)].getHandTransform(1)

        -- a table of offsets for each kind of cards
        local stack_offsets = Global.getTable('OBJECTS_OFFSETS')['stacks']

        -- for every kind of stack we then calculate the origin using our offsets
        for stack_name, _ in pairs(new_stack[string.lower(color)]['objects']) do

            -- the origin we are going to calculate
            local stack_origin = Vector(0, 0, 0)
            stack_origin[1] = origin.position[1] + origin.forward[1] * stack_offsets['z'] + origin.right[1] * stack_offsets[stack_name]
            stack_origin[2] = TABLE_HEIGHT
            stack_origin[3] = origin.position[3] + origin.forward[3] * stack_offsets['z'] + origin.right[3] * stack_offsets[stack_name]

            -- in the end we update the origin in our temp table
            new_stack[string.lower(color)]['objects'][stack_name]['origin'] = stack_origin
        end

    end

    -- lastly we commit the changes to the original table
    Global.setTable('PLAYERS', new_stack)

end

function populateStatusPanel()

    -- ! docstring
    -- the goal for this function is to populate the status UI everytime a player joins or changes color
    -- inside our Global.xml we already have a <TableLayout> inside a <Panel> ready to be populated

    -- for every n players we will "build" a n numbers of rows to "append" to that Panel xml element
    -- the xml schema to append will be as follows
    -- ? <Row>
    -- ?     <Cell>
    -- ?          <Panel class = 'statusBox'>
    -- ?          </Panel>
    -- ?     </Cell>
    -- ?     <Cell>
    -- ?          <Text class = 'playerName'> player.steam_name</Text>
    -- ?     </Cell>
    -- ? </Row>

    -- we'll have to parse that into a lua table with the following schema
    -- ? local row_to_append = 
    -- ? {
    -- ?     tag = 'Row',
    -- ?     attributes = {},                                -- ! <Row>
    -- ?     children = 
    --?      {
    -- ?         tag = 'Cell',
    -- ?         attributes = {},                                -- ! <Cell>
    -- ?         children = 
    -- ?         {
    -- ?             tag = 'Panel',
    -- ?             attributes = { class = 'statusBox' },           -- ! <Panel class = 'statusBox'></Panel>
    -- ?             children = {}
    -- ?         }
    -- ?     },                                                  -- ! </Cell>
    -- ?     {
    -- ?         tag = 'Cell',
    -- ?         attributes = {},                                -- ! <Cell>
    -- ?         children = 
    -- ?         {
    -- ?             tag = 'Text',
    -- ?             attributes = { class = 'playerName' },          -- ! <Text>player.steam_name</Text>
    -- ?             value = player.steam_name
    -- ?         }
    -- ?     }                                                   -- ! </Cell>
    -- ? }                                                   -- ! </Row>

    -- ! real function
    -- start reading this from the title_row table

    -- ? <Text> 
    local title_text = {
        tag = 'Text',
        attributes = {id = 'statusTitle', class = 'statusTitle'},
        value = 'WAITING TO START MATCH',
        children = {}
    }

    -- ? <Row> 
    local title_row = {
        tag = 'Row',
        attributes = {},
        children = {title_text}
    }

    -- the two tables above are just a parent and a children tag, like so:
    -- ? <Row>
    -- ?      <Text id = 'statusTitle' class = 'statusTitle'>WAITING TO START MATCH</Text>
    -- ? </Row>

    -- this we'll be our "collection" of all the row tag to append
    -- one row for each player in the match
    -- except for the first table, it will be the title of our panel
    local xml_to_append = {title_row}

    for _, player in pairs(getValidPlayers()) do

        -- start reading this from the last table, the row_tag trust me 

        -- the player name in question
        local player_text = {
            tag            = 'Text',
            attributes     = { class = 'playerName' },
            value          = player.color,
            children       = {}
        }

        -- and this is the second and last child of the <Row>
        -- this <Cell> contains that player's name, it will be displayed next to his status
        local name_cell = {
            tag            = 'Cell',
            attributes     = {},
            children       = {player_text}
        }

        -- the status box in question
        local status_panel = {
            tag            = 'Panel',
            attributes     = { class = 'statusBox' },
            children       = {}
        }

        -- this is the first child tag, the <Cell> containg the status box
        -- this box will display whenever a player is ready or not
        local status_cell = {
            tag            = 'Cell',
            attributes     = {},
            children       = {status_panel}
        }

        -- this the parent tag <Row> that contains every other table you see above this 
        local player_row = {
            tag            = 'Row',
            attributes     = { height = '32' },
            children       = {status_cell, name_cell}
        }

        xml_to_append[#xml_to_append + 1] = player_row
    end

    -- since it's not possibile to "append" the current Global.xml we first store it
    local global_xml = self.UI.getXmlTable()

    -- and then we overwrite it by adding these new rows
    -- more more specifically: 
    -- global_xml[2] -> is the second parent tag in Global.xml that is <Panel>
    -- .children[1]  -> refers to the first children tag of <Panel> that is <TableLayout>
    -- .children     -> this are all the children of <TableLayout> so an empty table
    global_xml[2].children[1].children = xml_to_append

    -- finally we set this dynamic xml table which will serve us for the entire runtime of the match
    self.UI.setXmlTable(global_xml)

end

function getValidPlayers()
    -- the tabletop api only gives u the Player.getPlayers() function wich will return a table of Player instances
    -- but we only want the players having a "valid colors" 
    -- so not players in the grey nor black seat

    local valid_colors = {'White', 'Purple', 'Red', 'Yellow', 'Green', 'Orange', 'Blue'}
    local valid_players = {}

    -- we compare every player's color with every valid colors and just append one that matches
    for _, player in pairs(Player.getPlayers()) do
        for _, color in pairs(valid_colors) do
            if player.color == color then
                table.insert(valid_players, player)
            end
        end
    end

    -- this is a Player instances table
    -- its pretty useful because we can get the steam name, the steam id, the color and many other things
    return valid_players
end

function onChat(message, player)
end